<section>
  
  <div style="display: flex; justify-content: space-between; align-items: center; flex-direction: row-reverse; margin-bottom: 20px;">
    <form class="buscador" onsubmit="return false;">
      <input
        style="max-width: none;"
        type="search"
        id="buscador-ordenes"
        placeholder="Buscar por c√≥digo de orden..."
        autocomplete="off"
        value="<%= params[:query] %>"
      />
    </form>

    <div style="display: flex; gap: 10px; align-items: center;">
      <%= link_to t("home.ordenes.ordenes_empleados"), employee_dashboard_orders_path, class: "btn-eliminar" %>
      <%= link_to request.path, class: "btn-eliminar", style: "display: flex; width: fit-content;" do %>
        <%= image_tag "icons/arrows-rotate-solid-full.svg", alt: "Refrescar", class: "btn-refresh" %>
      <% end %>
    </div>


  </div>

  <div>

    <% if @orders.any? %>

      <h1 class="orders-title"><%= t("home.ordenes.lista_ordenes")%></h1>

      <table class="orders-table">
        <thead class="orders-thead">
          <tr>
            <th class="orders-th"><%= t("home.ordenes.Id")%></th>
            <th class="orders-th"><%= t("home.ordenes.clientee")%></th>
            <th class="orders-th"><%= t("home.ordenes.estado")%></th>
            <th class="orders-th orders-th--right"><%= t("home.ordenes.total")%></th>
            <th class="orders-th">M√©todo de pago</th>
            <th class="orders-th"><%= t("home.ordenes.fecha")%></th>
            <th class="orders-th"><%= t("home.ordenes.acciones")%></th>
          </tr>
        </thead>
        <tbody class="orders-tbody">
          <% @orders.each do |order| %>
            <tr class="orders-tr" data-code="<%= order.code.downcase %>">
              <td class="orders-td" data-label="ID"><%= order.id %></td>
              <td class="orders-td" data-label="Cliente"><%= order.customer_name %> (<%= order.customer_email %>)</td>
              <td class="orders-td orders-td--status <%= "status-#{order.status}" %>" data-label="Estado">
                <p><%= order.status.humanize %></p>
              </td>
              <td class="orders-td orders-td--right" data-label="Total">
                $<%= number_to_currency(order.total, unit: "COP ", separator: ",", delimiter: ".") %>
                <% if order.coupon.present? %>
                  <br><small style="color: green;">Cup√≥n: <%= order.coupon.codigo %></small>
                <% end %>
              </td>
              <td class="orders-td" data-label="M√©todo de pago" style="text-align: center;">
                <% payment = order.payments.last %>
                <% if payment.present? %>
                  <% case payment.payment_method %>
                  <% when 'card' %>
                    üí≥ <%= payment.type_card == 'credit' ? 'Cr√©dito' : 'D√©bito' %>
                  <% when 'nequi' %>
                    <img src="/NequiLogo.png" alt="Nequi Logo" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 4px;"> Nequi
                  <% when 'pse' %>
                    üè¶ PSE
                  <% when 'cash' %>
                    üíµ Efectivo
                  <% else %>
                    <%= payment.payment_method.humanize %>
                  <% end %>
                <% else %>
                  <span style="color: #999;">Sin pago</span>
                <% end %>
              </td>

              <td class="orders-td" data-label="Fecha"><%= order.created_at.strftime("%d/%m/%Y %H:%M") %></td>
              <td class="orders-td orders-td--actions" data-label="Acciones">
                <%= link_to t("home.ordenes.ver_detalles"), dashboard_order_path(order), class: "btn-eliminar" %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div style="text-align: center; margin-top: 20px; color: gray;">
        No hay √≥rdenes registradas o en proceso.
      </div>
    <% end %>
  </div>
</section>


<script>
document.addEventListener("turbo:load", function () {
  const input = document.getElementById("buscador-ordenes");
  const rows = document.querySelectorAll(".orders-tbody .orders-tr");

  const normalizar = (str) => str.trim().toLowerCase();

  input.addEventListener("input", function () {
    const valor = normalizar(input.value);

    let visibles = 0;

    rows.forEach((row) => {
      const code = normalizar(row.dataset.code || "");
      const visible = code.includes(valor);
      row.style.display = visible ? "" : "none";
      if (visible) visibles++;
    });
  });
});
</script>