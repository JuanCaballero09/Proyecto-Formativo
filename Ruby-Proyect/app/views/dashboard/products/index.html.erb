<section>
  <h2>Lista de Productos</h2>

  <!-- Botones y buscador -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <div style="display: flex; gap: 10px;">
      <%= link_to "Nuevo Producto", new_dashboard_product_path, class: "btn-aggr" %>
      <%= link_to "Nuevo Combo", new_dashboard_product_path(type: "Combo"), class: "btn-aggr" %>
    </div>

    <%= form_with url: dashboard_products_path, method: :get, local: true, html: {class: "buscador"} do %>
      <%= search_field_tag :query, params[:query], placeholder: "Buscar producto...", autocomplete: "off", id: "buscador-productos" %>
    <% end %>
  </div>

  <!-- Secci칩n de Combos (siempre primero) -->
  <% if @combos.present? %>
    <div style="margin-bottom: 40px;">
      <h3 style="color: #e74c3c; border-bottom: 2px solid #e74c3c; padding-bottom: 10px; display: flex; align-items: center; gap: 10px;">
        <span>游꿀</span> COMBOS & PROMOCIONES
      </h3>
      <div class="productss">
        <% @combos.each do |combo| %>
          <div class="product-card" id="product-card-<%= combo.id %>" data-nombre="<%= I18n.transliterate(combo.nombre.downcase) %>">
            <h3><%= combo.nombre %></h3>
            <div class="img-wrapper shimmer">
              <div class="img-loader"></div>
              <img
                src="<%= combo.imagen.attached? ? url_for(combo.imagen_resized2) : asset_path('LogoLogoText2.svg') %>"
                alt="<%= combo.nombre %>"
                class="carta-imagen"
                onload="imageLoaded(this)"
                onerror="imageError(this)"
              >
            </div>
            <p><strong>ID:</strong> <%= combo.id %></p>

            <% if combo.respond_to?(:combo_items) && combo.combo_items.any? %>
              <p><strong>Componentes:</strong> 
                <%= combo.combo_items.includes(:product).map { |ci| "#{ci.cantidad}x #{ci.product.nombre}" }.join(", ") %>
              </p>
            <% end %>

            <p><strong>Descripci칩n:</strong> <%= truncate(combo.descripcion, length: 100) %></p>
            <p><strong>Precio:</strong> <%= number_to_currency(combo.precio, unit: "COP ", separator: ",", delimiter: ".", precision: 0) %></p>

            <div id="estado-<%= combo.id %>">
              <%= render "disponibilidad_toggle", product: combo %>
            </div>

            <div style="display: flex; gap: 6px; justify-content: center;">
              <%= link_to 'Editar', edit_dashboard_product_path(combo), class: 'btn btn-secondary' %>
              <%= form_with url: dashboard_product_path(combo), method: :delete, local: true, 
                    data: { turbo: false }, 
                    onsubmit: "return confirm('쮼st치s seguro de eliminar este combo?');" do |f| %>
                <%= f.submit 'Eliminar', class: 'btn-eliminar' %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Secci칩n de Productos por Grupo -->
  <% @productos_por_grupo&.each do |grupo, productos| %>
    <% if productos.any? %>
      <div style="margin-bottom: 40px;">
        <h3 style="color: var(--base); border-bottom: 2px solid var(--base-oscuro); padding-bottom: 5px; margin-bottom: 10px;">
          <%= grupo&.nombre || "Sin Categor칤a" %>
        </h3>

        <div class="productss">
          <% productos.each do |product| %>
            <div class="product-card" id="product-card-<%= product.id %>" data-nombre="<%= I18n.transliterate(product.nombre.downcase) %>">
              <h3><%= product.nombre %></h3>
              <div class="img-wrapper shimmer">
                <div class="img-loader"></div>
                <img
                  src="<%= product.imagen.attached? ? url_for(product.imagen_resized2) : asset_path('LogoLogoText2.svg') %>"
                  alt="<%= product.nombre %>"
                  class="carta-imagen"
                  onload="imageLoaded(this)"
                  onerror="imageError(this)"
                >
              </div>
              <p><strong>ID:</strong> <%= product.id %></p>
              <p><strong>Ingredientes:</strong> <%= product.ingredientes.map(&:nombre).join(", ") %></p>
              <p><strong>Descripci칩n:</strong> <%= product.descripcion %></p>
              <p><strong>Precio:</strong> <%= number_to_currency(product.precio, unit: "COP ", separator: ",", delimiter: ".", precision: 0) %></p>

              <div id="estado-<%= product.id %>">
                <%= render "disponibilidad_toggle", product: product %>
              </div>

              <div style="display: flex; gap: 6px; justify-content: center;">
                <%= link_to 'Editar', edit_dashboard_product_path(product), class: 'btn btn-secondary' %>
                <%= form_with url: dashboard_product_path(product), method: :delete, local: true, 
                      data: { turbo: false }, 
                      onsubmit: "return confirm('쮼st치s seguro de eliminar este producto?');" do |f| %>
                  <%= f.submit 'Eliminar', class: 'btn-eliminar' %>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>
</section>
