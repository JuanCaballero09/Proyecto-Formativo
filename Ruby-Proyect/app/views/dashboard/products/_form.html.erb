<script>
  // Pasar productos disponibles a JavaScript
  window.availableProductsForCombo = <%= raw (@products_for_combo || []).map { |p| { id: p.id, nombre: p.nombre } }.to_json %>;
</script>

<%= form_with model: [:dashboard, @product], local: true, html: { class: "dashboard-form", id: "product-form" } do |f| %>
  <div>
    <%= f.label :nombre %>
    <%= f.text_field :nombre, required: true %>
  </div>

  <div>
    <%= f.label :precio %>
    <%= f.number_field :precio, step: 0.01, required: true %>
  </div>

  <div>
    <%= f.label :type, "Tipo de producto" %>
    <%= f.select :type, options_for_select([["Producto Normal", ""], ["Combo", "Combo"]], @product.type), {}, { class: "form-control", id: "product-type" } %>
  </div>

  <!-- Secci√≥n de ingredientes (solo para productos normales) -->
  <div id="ingredientes-section" style="<%= 'display: none;' if @product.type == 'Combo' %>">
    <div>
      <%= f.label :ingredientes, "Ingredientes" %><br>
      <div style="border: 1px solid #ccc; padding: 10px; height: 150px; overflow-y: auto; border-radius: 5px;" class="ingredientes-list">
        <% if @ingredientes&.any? %>
          <% @ingredientes.each do |ingrediente| %>
            <label>
              <%= check_box_tag "product[ingrediente_ids][]", ingrediente.id, @product.ingrediente_ids.include?(ingrediente.id) %>
              <%= ingrediente.nombre %>
            </label><br>
          <% end %>
        <% else %>
          <p style="color: #666; font-style: italic;">No hay ingredientes disponibles. <a href="<%= dashboard_ingredientes_path %>">Crear ingredientes</a></p>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Secci√≥n de componentes del combo (solo para combos) -->
  <div id="combo-section" style="<%= 'display: none;' unless @product.type == 'Combo' %>">
    <label>Componentes del combo</label>
    <div class="combo-info" style="margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-left: 4px solid #007bff; border-radius: 4px;">
      <small style="color: #6c757d;">
        <strong>üí° Tip:</strong> Puedes agregar el mismo producto m√∫ltiples veces con diferentes cantidades o agregar diferentes productos para crear tu combo perfecto.
      </small>
    </div>
    <div id="combo-items">
      <%= f.fields_for :combo_items do |ci| %>
        <div class="combo-item" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center; padding: 10px; background-color: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6;">
          <%= ci.collection_select :product_id, (@products_for_combo || []), :id, :nombre, { prompt: "Seleccionar producto" }, { class: "form-control", style: "flex: 1;" } %>
          <div style="display: flex; align-items: center; gap: 5px;">
            <label style="margin: 0; font-size: 0.9em; color: #6c757d;">Cant:</label>
            <%= ci.number_field :cantidad, min: 1, step: 1, value: (ci.object&.cantidad || 1), class: "form-control", style: "width: 80px;" %>
          </div>
          <%= ci.check_box :_destroy, style: "display: none;" %>
          <button type="button" class="btn btn-danger btn-sm remove-combo-item" title="Quitar componente">üóëÔ∏è</button>
        </div>
      <% end %>
    </div>
    <div style="text-align: center; margin-top: 15px;">
      <button type="button" id="add-combo-item" class="btn btn-success btn-sm" style="padding: 8px 16px;">
        <span style="font-size: 1.1em;">‚ûï</span> Agregar componente
      </button>
    </div>
  </div>

  <div>
    <%= f.label :descripcion %>
    <%= f.text_area :descripcion, required: true %>
  </div>

  <div id="grupo-section" style="<%= 'display: none;' if @product.type == 'Combo' %>">
    <%= f.label :grupo_id, "Grupo" %>
    <%= f.collection_select :grupo_id, Grupo.all, :id, :nombre, { prompt: "Seleccionar grupo" }, { required: false, id: "grupo-select" } %>
  </div>

  <div>
    <%= f.label :imagen %>
    <%= f.file_field :imagen, accept: 'image/*', id: 'imagen-input'%>
    
    <% if @product.persisted? && @product.imagen.attached? %>
      <div class="current-image" style="margin-top: 10px;">
        <p><strong>Imagen actual:</strong></p>
        <%= image_tag @product.imagen, alt: @product.nombre, style: "max-width: 200px; height: auto; border: 1px solid #ddd; border-radius: 5px;" %>
        <p style="font-size: 0.9em; color: #666;">Subir una nueva imagen reemplazar√° la actual</p>
      </div>
    <% elsif @product.persisted? %>
      <div class="current-image" style="margin-top: 10px;">
        <p style="color: #666; font-style: italic;">No hay imagen actualmente</p>
      </div>
    <% end %>
  </div>

  <div class="checkbox-container">
    <%= f.label :disponible %>
    <%= f.check_box :disponible %>
  </div>

  <div>
    <%= f.submit @product.new_record? ? "Crear producto" : "Actualizar producto" %>
  </div>
<% end %>

<script>
(function() {
  'use strict';

  const ProductFormManager = {
    form: null,
    typeSelect: null,
    ingredientesSection: null,
    comboSection: null,
    addComboButton: null,
    comboItemsContainer: null,
    grupoSelect: null,
    availableProducts: window.availableProductsForCombo || [],
    initialized: false,

    init: function() {
      if (this.initialized) return;

      this.form = document.getElementById("product-form");
      if (!this.form) return;

      this.typeSelect = document.getElementById("product-type");
      this.ingredientesSection = document.getElementById("ingredientes-section");
      this.comboSection = document.getElementById("combo-section");
      this.addComboButton = document.getElementById("add-combo-item");
      this.comboItemsContainer = document.getElementById("combo-items");
      this.grupoSelect = document.getElementById("grupo-select");

      if (!this.typeSelect || !this.addComboButton || !this.comboItemsContainer) return;

      this.attachEvents();
      this.toggleSections();
      this.initialized = true;
    },

    attachEvents: function() {
      const self = this;

      this.typeSelect.addEventListener("change", function() {
        self.toggleSections();
      });

      this.addComboButton.addEventListener("click", function() {
        self.createComboItem();
      });

      this.form.addEventListener("submit", function(event) {
        self.validateCombo(event);
      });

      document.addEventListener("click", function(e) {
        if (e.target.classList.contains("remove-combo-item")) {
          self.removeComboItem(e.target);
        }
      });
    },

    toggleSections: function() {
      if (this.typeSelect.value === "Combo") {
        this.ingredientesSection.style.display = "none";
        this.comboSection.style.display = "block";
        document.getElementById("grupo-section").style.display = "none";
        this.grupoSelect.required = false;
      } else {
        this.ingredientesSection.style.display = "block";
        this.comboSection.style.display = "none";
        document.getElementById("grupo-section").style.display = "block";
        this.grupoSelect.required = true;
      }
    },

    createComboItem: function() {
      const timestamp = Date.now();
      const newItem = document.createElement("div");
      newItem.className = "combo-item";
      newItem.style.cssText = "display:flex;gap:10px;margin-bottom:10px;align-items:center;padding:10px;background:#f8f9fa;border-radius:5px;border:1px solid #dee2e6;";

      const optionsHtml = this.availableProducts
        .map(p => `<option value="${p.id}">${p.nombre}</option>`)
        .join("");

      newItem.innerHTML = `
        <select name="product[combo_items_attributes][${timestamp}][product_id]" class="form-control" style="flex:1;">
          <option value="">Seleccionar producto</option>
          ${optionsHtml}
        </select>
        <div style="display:flex;align-items:center;gap:5px;">
          <label style="margin:0;font-size:0.9em;color:#6c757d;">Cant:</label>
          <input type="number"
            name="product[combo_items_attributes][${timestamp}][cantidad]"
            min="1" value="1"
            class="form-control"
            style="width:80px;">
        </div>
        <input type="hidden"
          name="product[combo_items_attributes][${timestamp}][_destroy]"
          value="false">
        <button type="button" class="btn btn-danger btn-sm remove-combo-item" title="Quitar componente">üóëÔ∏è</button>
      `;

      this.comboItemsContainer.appendChild(newItem);
    },

    removeComboItem: function(btn) {
      const item = btn.closest(".combo-item");
      if (!item) return;

      const destroyField = item.querySelector('input[name*="_destroy"]');

      if (destroyField) {
        destroyField.value = "true";
        item.style.opacity = "0.5";
        item.style.pointerEvents = "none";
        item.style.display = "none";
      } else {
        item.remove();
      }
    },

    validateCombo: function(event) {
      if (this.typeSelect.value !== "Combo") return;

      const items = Array.from(document.querySelectorAll(".combo-item"));
      const validItems = items.filter(item => {
        const destroyField = item.querySelector('input[name*="_destroy"]');
        const destroyed = destroyField && destroyField.value === "true";
        const productSelect = item.querySelector("select");
        const qtyInput = item.querySelector("input[type=number]");
        const product = productSelect ? productSelect.value : "";
        const qty = qtyInput ? Number(qtyInput.value) : 0;

        return (!destroyed && product && qty > 0);
      });

      if (validItems.length === 0) {
        event.preventDefault();
        alert("‚ö†Ô∏è El combo necesita al menos un componente.");
      }
    }
  };

  // Inicializar cuando el DOM est√© listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      ProductFormManager.init();
    });
  } else {
    ProductFormManager.init();
  }
})();
</script>
