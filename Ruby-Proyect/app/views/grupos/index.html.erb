<% grupos_con_productos = @grupos.select { |grupo| grupo.products.any?(&:disponible) } %>
<% combos_group = Grupo.find_by(nombre: ["Combos", "combo", "COMBOS"]) %>
<% combos_disponibles = combos_group&.products&.where(type: "Combo", disponible: true) || Product.where(type: "Combo", disponible: true) %>

<% if grupos_con_productos.any? || combos_disponibles.any? %>
  <section class="grupos-index-modern">
    <!-- Header con t√≠tulo mejorado -->
    <div class="grupos-header">
      <h1 class="grupos-titulo"><%= t("home.categoria.nuestras_categorias")%></h1>
      <p class="grupos-subtitulo"><%= t("home.categoria.descubre")%></p>
    </div>

    <div class="grupos-grid-container">
      <!-- Combos como grupo especial (si existen) -->
      <% if combos_disponibles.any? %>
        <div class="grupo-carta grupo-carta-combos">
          <% link_url = combos_group ? grupo_products_path(combos_group) : "/combos" %>
          <%= link_to link_url, class: "grupo-carta-link" do %>
            <div class="grupo-imagen combo-imagen-especial">
              <div class="combo-content">
                <div class="combo-gift-icon">üéÅ</div>
              </div>
              <div class="grupo-overlay">
                <div class="combo-badge">
                  <span class="combo-count-badge"><%= combos_disponibles.count %> <%= combos_disponibles.count == 1 ? 'combo' : 'combos' %></span>
                </div>
              </div>
            </div>
            <div class="grupo-info">
              <h3><%= t("home.categoria.combos_promociones")%></h3>
              <p><%=t("home.categoria.descubre_ofertas")%></p>
              <div class="combo-stats">
                <span class="combo-count"><%= combos_disponibles.count %> combos disponibles</span>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>

      <!-- Grupos regulares -->
      <% @grupos.each do |grupo| %>
        <% next if grupo.nombre.match?(/üéÅ|combos/i) %> <!-- Excluir grupo de combos -->
        <% productos_disponibles = grupo.products.select(&:disponible) %>
        
        <% if productos_disponibles.any? %>
          <div class="grupo-carta">
            <%= link_to grupo_products_path(grupo), class: "grupo-carta-link" do %>
              <div class="grupo-imagen">
                <div class="img-wrapper shimmer">
                  <div class="img-loader"></div>
                  <img
                    src="<%= grupo.imagen.attached? ? url_for(grupo.imagen_resized) : asset_path('LogoLogoText2.svg') %>"
                    alt="<%= grupo.nombre %>"
                    class="carta-imagen"
                    style="outline-offset: 0;"
                    onload="imageLoaded(this)"
                    onerror="imageError(this)"
                  >
                </div>
                <div class="grupo-overlay">
                  <div class="productos-count">
                    <span class="count-number"><%= productos_disponibles.count %></span>
                    <span class="count-text"><%= t("home.categoria.productos")%></span>
                  </div>
                </div>
              </div>
              <div class="grupo-info">
                <h3><%= grupo.nombre %></h3>
                <p><%= grupo.descripcion.present? ? truncate(grupo.descripcion, length: 80) : "Explora nuestra selecci√≥n de #{grupo.nombre.downcase}" %></p>
                <div class="grupo-meta">
                  <span class="producto-count"><%= productos_disponibles.count %> <%= t("home.categoria.products_disponibles")%></span>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>
  </section>
<% else %>
  <div class="sin-productos">
    <%= image_tag "ProductoNoDisponible.png", alt: t("home.categoria.no_disponible") %>
    <h2><%= t("home.categoria.sin_grupo")%></h2>
    <p><%= t("home.categoria.sin_categoria")%></p>
  </div>
<% end %>