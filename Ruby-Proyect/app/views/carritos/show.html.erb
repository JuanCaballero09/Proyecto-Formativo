<section class="carrito-modern">
  <div class="carrito-container">
    <!-- Header del carrito -->
    <div class="carrito-header">
      <div class="header-content">
        <div class="header-icon">🛒</div>
        <div class="header-info">
          <h1 class="carrito-titulo"><%= t("home.carrito.tu_carrito")%></h1>
          <% unless @items.empty? %>
            <p class="carrito-subtitulo">
              <span class="item-count"><%= @carrito.carrito_items.sum(:cantidad) %></span> 
              <%= @carrito.carrito_items.sum(:cantidad) == 1 ? "producto" : t("home.carrito.productos_carritos") %> 
            </p>
          <% end %>
        </div>
      </div>
    </div>

    <% if @items.empty? %>
      <!-- Carrito vacío -->
      <div class="carrito-vacio">
        <div class="vacio-icon">🛒</div>
        <h3 class="vacio-titulo"><%= t("home.carrito.carrito_vacio")%></h3>
        <p class="vacio-descripcion"><%= t("home.carrito.agrega_producto")%></p>
        <%= link_to t("home.carrito.explorar_productos"), products_path, class: "btn-explorar" %>
      </div>
    <% else %>
      <!-- Información del cliente para invitados - Aparece arriba -->
      <% unless current_user %>
        <div class="guest-info-top">
          <div class="guest-info-section">
            <h4><i class="user-icon">👤</i> Información del cliente</h4>
            <div class="guest-fields">
              <div class="field-row">
                <input type="text" name="guest_nombre" placeholder="Nombre" class="guest-input" required minlength="3" form="checkout-form">
                <input type="text" name="guest_apellido" placeholder="Apellido" class="guest-input" required minlength="3" form="checkout-form">
              </div>
              <div class="field-row">
                <input type="email" name="guest_email" placeholder="Correo electrónico" class="guest-input" required form="checkout-form">
                <input type="tel" name="guest_telefono" placeholder="Teléfono" class="guest-input" required minlength="8" maxlength="10" form="checkout-form">
              </div>
            </div>
            <small class="guest-help">💡 Estos datos son necesarios para contactarte sobre tu pedido</small>
          </div>
        </div>
      <% end %>

      <div class="carrito-content">
        <!-- Items del carrito -->
        <div class="carrito-items-section">
          <div class="items-header">
            <h3 class="items-titulo"><%= t("home.carrito.producto_selecionado")%></h3>
            <div class="items-contador">
              <span id="contador-productos"><%= @carrito.carrito_items.sum(:cantidad) %></span>
              <%= @carrito.carrito_items.sum(:cantidad) == 1 ? "item" : "items" %>
            </div>
          </div>
          
          <%= turbo_frame_tag "carrito", class: "carrito-items-list" do %>
            <%= render partial: "carritos/item",
                       collection: @carrito.carrito_items,
                       as: :item %>
          <% end %>
        </div>

        <!-- Sidebar con totales y acciones -->
        <div class="carrito-sidebar">
          <!-- Cupón - Solo para usuarios autenticados -->
          <% if current_user %>
            <div class="cupon-section">
              <%= turbo_frame_tag "carrito-cupon" do %>
                <%= render "carritos/cupon", carrito: @carrito %>
              <% end %>
            </div>
          <% end %>

          <!-- Totales -->
          <div class="totales-section">
            <div class="totales-card">
              <h3 class="totales-titulo"><%= t("home.carrito.resumen_pedido")%></h3>
              
              <div id="totales-carrito" class="totales-detalle">
                <div class="total-item">
                  <span class="total-label">Subtotal:</span>
                  <span class="total-value">
                    <strong class="precio-total"
                        data-precio="<%= @carrito.subtotal %>"
                        data-locale="<%= I18n.locale %>">
                        <% if I18n.locale == :en %>
                          <%= number_to_currency(@carrito.subtotal/ 4000, unit: "USD", format: "%n %u", precision: 2) %>
                        <% else %>
                          <%= number_to_currency(@carrito.subtotal, unit: "COP", separator: ",", delimiter: ".", format: "%n %u", precision: 2) %>
                        <% end %>
                      </strong>
                    </span>
                </div>
                
                <% if @carrito.descuento > 0 %>
                  <div class="total-item descuento">
                    <span class="total-label"><%= t("home.carrito.descuento")%></span>
                    <span class="total-value">
                      -<strong class="precio-unitario" 
                        data-precio= "<%= @carrito.descuento %>"
                        data-locale="<%= I18n.locale %>">
                        <% if I18n.locale == :en %>
                          <%= number_to_currency(@carrito.descuento/4000, unit: "USD",  format:"%n %u", precision: 2)%>
                        <% else %>
                          <%= number_to_currency(@carrito.descuento, unit:"COP", separator: ",", delimiter: ".", format:"%n %u", precision: 2)%>
                        <% end %>  
                      </strong>
                    </span>
                  </div>
                <% end %>
                
                <div class="total-item total-final">
                  <span class="total-label">Total:</span>
                  <span class= "total-value">
                      <strong class="precio-total"
                        data-precio="<%= @carrito.total %>"
                        data-locale="<%= I18n.locale %>">
                        <% if I18n.locale == :en %>
                          <%= number_to_currency(@carrito.total/ 4000, unit: "USD", format: "%n %u", precision: 2) %>
                        <% else %>
                          <%= number_to_currency(@carrito.total, unit: "COP", separator: ",", delimiter: ".", format: "%n %u", precision: 2) %>
                        <% end %>
                    </strong>
                  </span>
                </div>
              </div>


              <!-- Botón de compra -->
              <div class="checkout-section">
                <!-- Campo de dirección -->
                <div class="direccion-section">
                  <h4><i class="address-icon">📍</i> <%= t("home.order.direccion_entrega", default: "Dirección de entrega") %></h4>
                  <%= form_with url: orders_path, method: :post, local: true, class: "checkout-form", id: "checkout-form" do |f| %>
                    <%= f.text_area :direccion, 
                                        placeholder: "Ej: Calle 123 #45-67, Apto 101, Barrio Centro, Barranquilla", 
                                        class: "direccion-input",
                                        required: true,
                                        rows: 3,
                                        id: "direccion-input" %>
                    <small class="direccion-help">Por favor incluye dirección completa, puntos de referencia y notas especiales</small>
                    
                    <%= f.submit t("home.show-vista.ir_a_pagar"), class: "btn-checkout", id: "btn-generar-orden" %>
                  <% end %>
                </div>
                
                <p class="checkout-info">
                  <span class="info-icon">🔒</span>
                  <%= t("home.carrito.pago_protegido")%>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Información adicional - Movida abajo -->
      <div class="info-adicional-bottom">
        <div class="info-item">
          <span class="info-icon">🚚</span>
          <div class="info-content">
            <h4><%= t("home.carrito.entrega")%></h4>
            <p><%= t("home.carrito.recibe")%></p>
          </div>
        </div>
        <div class="info-item">
          <span class="info-icon">💳</span>
          <div class="info-content">
            <h4><%= t("home.carrito.pagooo")%></h4>
            <p><%= t("home.carrito.multiple_metodo")%></p>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</section>
