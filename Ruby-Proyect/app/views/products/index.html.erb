<section id="productosIndex">
  <% productos_por_grupo = @products.group_by(&:grupo) %>
  
  <% # Separar el grupo de combos y ordenar %>
  <% grupo_combos = productos_por_grupo.find { |grupo, productos| grupo&.nombre&.downcase&.match?(/combo/) } %>
  <% otros_grupos = productos_por_grupo.reject { |grupo, productos| grupo&.nombre&.downcase&.match?(/combo/) } %>
  
  <% # Reorganizar para mostrar combos primero %>
  <% grupos_ordenados = [] %>
  <% grupos_ordenados << grupo_combos if grupo_combos %>
  <% grupos_ordenados.concat(otros_grupos.to_a) %>

  <% if @products.any? %>
    <% grupos_ordenados.each do |grupo, productos| %>
      <div class="grupo" >
        <h2><%= grupo.nombre %></h2>

        <div class="slider-wrapper">
          <button class="botonL" onclick="moverSlider('slider-<%= grupo.id %>', -1)">←</button>

          <div class="slider-container" id="slider-<%= grupo.id %>">
            <% productos.each do |producto| %>
              <div class="carta">
                <%= link_to grupo_product_path(producto.grupo, producto), class: "carta-link" do %>
                  <div class="img-wrapper shimmer">
                    <div class="img-loader"></div>
                    <img
                      src="<%= producto.imagen.attached? ? url_for(producto.imagen_resized) : asset_path('LogoLogoText2.svg') %>"
                      alt="<%= producto.nombre %>"
                      class="carta-imagen"
                      onload="imageLoaded(this)"
                      onerror="imageError(this)"
                    >
                  </div>

                  <div class="carta-info">
                    <h4 class="carta-nombre"><%= producto.nombre %></h4>
                    <p class="carta-precio"><strong class="precio-unitario" data-precio="<%= producto.precio %>" data-locale="<%= I18n.locale %>">$</strong></p>
                  </div>
                <% end %>
                <div class="carta-acciones">
                  <%= button_to t("home.carrito.agregar_carrito"), 
                               carrito_items_path(product_id: producto.id), 
                               method: :post, 
                               class: "carta-btn",
                               data: { turbo_frame: "_top" } %>
                </div>
              </div>
            <% end %>
          </div>

          <button class="botonR" onclick="moverSlider('slider-<%= grupo.id %>', 1)">→</button>
        </div>
      </div>
    <% end %>
  <% else %>
    <div class="sin-productos">
      <%= image_tag "ProductoNoDisponible.png", alt: "Producto No Disponible" %>
      <h2>No hay productos disponibles por ahora.</h2>
    </div>
  <% end %>
</section>
