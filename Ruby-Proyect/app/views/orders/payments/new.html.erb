  <div class="simple-payment-container">
    <div class="simple-payment-header">
      <h1><%= t("home.order-pago.pagar_orden")%> <%= @order.code %></h1>
      <p><%= t("home.order-pago.completa")%></p>
    </div>

    <div class="simple-payment-grid">
      <!-- Order Summary -->
      <div class="simple-order-summary">
        <h3><%= t("home.order-pago.resumen")%></h3>
        
        <div class="simple-order-items">
          <% @order.order_items.each do |item| %>
            <div class="simple-order-item">
              <div class="item-info">
                <span class="item-name"><%= item.product.nombre %></span>
                <span class="item-details"> 
                  <%= t("home.ordenes.cantidadd")%> <%= item.quantity %> x 
                  <span class="precio" >
                    <strong class= "precio-unitario" data-precio="<%= item.product.precio %>" data-locale="<%= I18n.locale %>"></strong> 
                  </span>
                </span>
              </div>
              <span class="item-total">
                <strong class= "precio-unitario" data-precio="<%= item.quantity * item.product.precio %>" data-locale="<%= I18n.locale %>"></strong> 
              </span>
            </div>
          <% end %>
        </div>

        <div class="simple-order-footer">
          <% if @order.coupon.present? %>
            <div class="coupon-line">
              <span>Cup√≥n (<%= @order.coupon.codigo %>):</span>
              <span class="discount">
                <% if @order.coupon.tipo_descuento == "porcentaje" %>
                  - <%= @order.coupon.valor.to_i %>%
                <% else %>
                  - <%= number_to_currency(@order.coupon.valor, unit: "COP ", separator: ",", delimiter: ".") %>
                <% end %>
              </span>
            </div>
          <% end %>
          
          <div class="total-line">
            <span><%= t("home.carrito.total_pagar")%></span>
            <span class="total-amount">
              <span class="precio">
                <strong class="precio-total"
                  data-precio="<%= @order.total %>"
                  data-locale="<%= I18n.locale %>"> 
                  <% if I18n.locale == :en %>
                    <%= number_to_currency(@order.total/ 4000, unit: "USD", format: "%n %u", precision: 2) %>
                  <% else %>
                    <%= number_to_currency(@order.total, unit: "COP", format: "%n %u", precision: 2) %>
                  <% end %>
                </strong>
              </span>
            </span>
          </div>
        </div>
      </div>

      <!-- Payment Form -->
      <div class="simple-payment-form">
        <h3><%= t("home.order-pago.info_pago")%></h3>
        
        <%= form_tag order_payments_path(@order), method: :post, id: "payment-form", class: "simple-form" do %>
          
          <!-- Paso 1: Selecci√≥n de m√©todo de pago -->
          <div id="payment-method-selection" class="payment-step">
            <h4 class="step-title">Selecciona tu m√©todo de pago</h4>
            
            <div class="payment-methods-grid">
              <div class="payment-method-card" data-method="card">
                <div class="method-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                    <line x1="1" y1="10" x2="23" y2="10"></line>
                  </svg>
                </div>
                <h5>Tarjeta de Cr√©dito/D√©bito</h5>
                <p>Paga con tu tarjeta de forma segura</p>
              </div>

              <div class="payment-method-card" data-method="nequi">
                <div class="method-icon nequi-icon">
                  <img src="/NequiLogo.png" alt="Nequi Logo" style="width:24px; height:24px;" />
                </div>
                <h5>Nequi</h5>
                <p>Pago r√°pido con notificaci√≥n push</p>
                <div class="nequi-info">
                  <small>
                    <strong>Importante:</strong> Recibir√°s una notificaci√≥n push de Nequi en tu celular 
                    para aceptar o rechazar la transacci√≥n. El resultado se reflejar√° en segundos.
                  </small>
                </div>
              </div>

              <div class="payment-method-card" data-method="cash">
                <div class="method-icon cash-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="6" width="20" height="12" rx="2"/>
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M6 12h.01M18 12h.01"/>
                  </svg>
                </div>
                <h5>Efectivo</h5>
                <p>Paga en efectivo al recibir tu pedido</p>
                <div class="cash-info">
                  <small>
                    Tu pedido ser√° preparado y enviado. Pagar√°s en efectivo al domiciliario cuando recibas tu orden.
                  </small>
                </div>
              </div>
            </div>
          </div>

          <!-- Paso 2: Selecci√≥n de tipo de tarjeta (solo para tarjetas) -->
          <div id="card-type-selection" class="payment-step" style="display: none;">
            <div class="step-header">
              <button type="button" class="back-button" data-back-to="payment-method-selection">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="19" y1="12" x2="5" y2="12"></line>
                  <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
                Volver
              </button>
              <h4 class="step-title">Selecciona el tipo de tarjeta</h4>
            </div>

            <div class="payment-methods-grid">
              <div class="payment-method-card" data-card-type="credit">
                <div class="method-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                    <line x1="1" y1="10" x2="23" y2="10"></line>
                    <line x1="5" y1="15" x2="9" y2="15"></line>
                  </svg>
                </div>
                <h5>Tarjeta de Cr√©dito</h5>
                <p>Paga en cuotas de 1 a 36 meses</p>
              </div>

              <div class="payment-method-card" data-card-type="debit">
                <div class="method-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                    <line x1="1" y1="10" x2="23" y2="10"></line>
                    <circle cx="7" cy="15" r="1"></circle>
                  </svg>
                </div>
                <h5>Tarjeta D√©bito</h5>
                <p>Pago √∫nico sin cuotas</p>
              </div>
            </div>
          </div>

          <!-- Campos ocultos para m√©todo y tipo -->
          <%= hidden_field_tag 'payment[payment_method]', '', id: "payment-method-selector" %>
          <%= hidden_field_tag 'payment[type_card]', '', id: "card-type-selector" %>

          <!-- Paso 3: Formulario de pago -->
          <div id="payment-form-section" class="payment-step" style="display: none;">
            <div class="step-header">
              <button type="button" class="back-button" id="back-from-form">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="19" y1="12" x2="5" y2="12"></line>
                  <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
                Volver
              </button>
              <h4 class="step-title" id="form-title">Completa tu informaci√≥n</h4>
            </div>

          <!-- Campos para TARJETA -->
          <div id="card-fields" style="display: none;">
            <div class="form-field">
              <%= label_tag 'payment[card_number]', t("home.order-pago.numero-tarjeta"), class: "field-label" %>
              <%= text_field_tag 'payment[card_number]', nil,
                  maxlength: 19, 
                  class: "field-input", 
                  placeholder: "1234 5678 9012 3456",
                  inputmode: "numeric",
                  maxlength: 16,
                  minlength: 15,
                  pattern: "[0-9\s]*",
                  autocomplete: "cc-number" %>
              <span id="error-card" class="error-msg"></span>
            </div>

            <div class="form-row">
              <div class="form-field">
                <%= label_tag 'payment[exp_month]', t("home.order-pago.mes-expiracion"), class: "field-label" %>
                <%= select_tag 'payment[exp_month]',
                    options_for_select((1..12).map { |m| [sprintf("%02d", m), m] }, nil), 
                    prompt: "Mes",
                    class: "field-select" %>
                <span id="error-month" class="error-msg"></span>
              </div>

              <div class="form-field">
                <%= label_tag 'payment[exp_year]', t("home.order-pago.a√±o-expiracion"), class: "field-label" %>
                <%= select_tag 'payment[exp_year]',
                    options_for_select((Date.today.year..(Date.today.year+10)).map { |y| [y.to_s, y] }, nil), 
                    prompt: "A√±o",
                    class: "field-select" %>
                <span id="error-year" class="error-msg"></span>
              </div>
            </div>

            <div class="form-row">
              <div class="form-field">
                <%= label_tag 'payment[cvc]', "CVC", class: "field-label" %>
                <%= text_field_tag 'payment[cvc]', nil,
                    maxlength: 4, 
                    class: "field-input", 
                    placeholder: "123",
                    inputmode: "numeric",
                    pattern: "[0-9]*",
                    autocomplete: "cc-csc" %>
                <span id="error-cvc" class="error-msg"></span>
              </div>

              <div class="form-field">
                <%= label_tag 'payment[card_holder]', t("home.order-pago.nombre-titular"), class: "field-label" %>
                <%= text_field_tag 'payment[card_holder]', @order.customer_name,
                    class: "field-input", 
                    placeholder: t("home.order-pago.nombre_completo") %>
                <span id="error-holder" class="error-msg"></span>
              </div>
            </div>

            <!-- Cuotas (solo para cr√©dito) -->
            <div class="form-field" id="installments-field" style="display: none;">
              <%= label_tag 'payment[installments]', "N√∫mero de cuotas", class: "field-label" %>
              <%= select_tag 'payment[installments]',
                  options_for_select((1..36).map { |i| [i == 1 ? "1 cuota (sin intereses)" : "#{i} cuotas", i] }, 1),
                  class: "field-select" %>
            </div>
          </div>

          <!-- Campos para NEQUI -->
          <div id="nequi-fields" style="display: none;">
            <div class="form-field">
              <%= label_tag 'payment[phone_number]', "N√∫mero de celular Nequi", class: "field-label" %>
              <%= text_field_tag 'payment[phone_number]', nil,
                  maxlength: 10, 
                  class: "field-input", 
                  placeholder: "3001234567",
                  inputmode: "numeric",
                  pattern: "[0-9]*",
                  id: "nequi-phone-input" %>
              <span id="error-phone" class="error-msg"></span>
              <small class="field-hint">Aseg√∫rate de tener la app de Nequi instalada en tu celular</small>
            </div>
          </div>

          <!-- Email (com√∫n para todos) -->
          <div class="form-field">
            <%= label_tag 'payment[email]', t("home.order-pago.correo-electronico"), class: "field-label" %>
            <%= email_field_tag 'payment[email]', @order.customer_email,
                class: "field-input", 
                placeholder: "tu@email.com",
                id: "payment-email-input" %>
            <span id="error-email" class="error-msg"></span>
          </div>

          <div class="checkbox-section">
            <div class="checkbox-item">
              <%= check_box_tag 'payment[accept_terms]', '1', false, class: "checkbox" %>
              <%= label_tag 'payment_accept_terms', class: "checkbox-label" do %>
                Acepto los 
                <a href="https://wompi.com/assets/downloadble/reglamento-Usuarios-Colombia.pdf?_gl=1*126i4oi*_gcl_aw*R0NMLjE3NTYyMjY0MjQuQ2p3S0NBand0clhGQmhCaUVpd0FFK2VuMXpvMWtBb2dwUkpBWklvc3JjNkJuZ3NIRktrMVRfT3hzODRBWnFTQXdhNGd2Z3JLaVhBWGhSb0NJVnNRQXZEX0J3RQ..*_gcl_au*MjA5MDc4MDUwMy4xNzU1NzE1ODAz*_ga*MTMzNjc3NjQyNC4xNzU1NzE1ODA1*_ga_BQ9HE5B63X*czE3NTYyMjY0MzUkbzE0JGcxJHQxNzU2MjI2ODQ2JGo2MCRsMCRoMA.." target="_blank">t√©rminos y condiciones</a>
                de Wompi
              <% end %>
            </div>
            <div class="checkbox-item">
              <%= check_box_tag 'payment[accept_data]', '1', false, class: "checkbox" %>
              <%= label_tag 'payment_accept_data', class: "checkbox-label" do %>
                Acepto la
                <a target="_blank" href="https://wompi.com/assets/downloadble/autorizacion-tratamiento-datos-personales.pdf?_gl=1*jcrp79*_gcl_aw*R0NMLjE3NTYyMjY0MjQuQ2p3S0NBand0clhGQmhCaUVpd0FFK2VuMXpvMWtBb2dwUkpBWklvc3JjNkJuZ3NIRktrMVRfT3hzODRBWnFTQXdhNGd2Z3JLaVhBWGhSb0NJVnNRQXZEX0J3RQ..*_gcl_au*MjA5MDc4MDUwMy4xNzU1NzE1ODAz*_ga*MTMzNjc3NjQyNC4xNzU1NzE1ODA1*_ga_BQ9HE5B63X*czE3NTYyMjY0MzUkbzE0JGcxJHQxNzU2MjI2NTU3JGo0JGwwJGgw">autorizaci√≥n para la administraci√≥n de datos personales</a>
                y conozco la 
                <a target="_blank" href="https://wompi.com/es/co/politica-de-privacidad?_gl=1*13f7i2g*_gcl_aw*R0NMLjE3NTYyMjY0MjQuQ2p3S0NBand0clhGQmhCaUVpd0FFK2VuMXpvMWtBb2dwUkpBWklvc3JjNkJuZ3NIRktrMVRfT3hzODRBWnFTQXdhNGd2Z3JLaVhBWGhSb0NJVnNRQXZEX0J3RQ..*_gcl_au*MjA5MDc4MDUwMy4xNzU1NzE1ODAz*_ga*MTMzNjc3NjQyNC4xNzU1NzE1ODA1*_ga_BQ9HE5B63X*czE3NTYyMjY0MzUkbzE0JGcxJHQxNzU2MjI2NTU3JGo0JGwwJGgw" target="_blank">pol√≠tica para el tratamiento de datos personales.</a>
              <% end %>
            </div>
          </div>

          <div class="submit-section">
            <%= submit_tag t("home.order-pago.pagar"), id: "pay-btn", class: "pay-button" %>
            <p class="security-note">üîí <%= t("home.order-pago.pago_seguro")%></p>
          </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <style>
    .payment-step {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .step-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 25px;
    }

    .back-button {
      background: #f5f5f5;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #333;
      transition: all 0.2s;
    }

    .back-button:hover {
      background: #e0e0e0;
    }

    .back-button svg {
      width: 18px;
      height: 18px;
    }

    .step-title {
      margin: 0;
      font-size: 1.3rem;
      color: #333;
    }

    .payment-methods-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .payment-method-card {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 25px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }

    .payment-method-card:hover {
      border-color: #FF6B35;
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(255, 107, 53, 0.2);
    }

    .payment-method-card.selected {
      border-color: #FF6B35;
      background: #fff5f2;
    }

    .method-icon {
      width: 60px;
      height: 60px;
      margin: 0 auto 15px;
      background: #f5f5f5;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #FF6B35;
    }

    .method-icon svg {
      width: 30px;
      height: 30px;
    }

    .nequi-icon {
      background: #f8e6ff;
      color: #8B34D9;
    }

    .cash-icon {
      background: #e8f5e9;
      color: #4CAF50;
    }

    .payment-method-card h5 {
      margin: 10px 0;
      font-size: 1.1rem;
      color: #333;
    }

    .payment-method-card p {
      margin: 5px 0;
      font-size: 0.9rem;
      color: #666;
    }

    .nequi-info {
      margin-top: 15px;
      background: #fff;
      border-radius: 8px;
      text-align: center;
    }

    .nequi-info small {
      font-size: 0.7rem;
      color: #555;
      line-height: 1.4;
    }

    .cash-info {
      margin-top: 15px;
      padding: 12px;
      background: #fff;
      border-radius: 8px;
      text-align: center;
    }

    .cash-info small {
      font-size: 0.8rem;
      color: #555;
      line-height: 1.4;
    }

    .field-hint {
      display: block;
      margin-top: 5px;
      font-size: 0.85em;
      color: #666;
    }
  </style>

  <script>
  function initializePaymentForm() {
    console.log('üöÄ Inicializando formulario de pago');
    
    // Variables globales
    var paymentMethodSelector = document.getElementById('payment-method-selector');
    var paymentMethodSelection = document.getElementById('payment-method-selection');
    var cardTypeSelection = document.getElementById('card-type-selection');
    var paymentFormSection = document.getElementById('payment-form-section');
    var cardFields = document.getElementById('card-fields');
    var nequiFields = document.getElementById('nequi-fields');
    var installmentsField = document.getElementById('installments-field');
    var cardTypeSelector = document.getElementById('card-type-selector');
    var form = document.getElementById('payment-form');
    var payBtn = document.getElementById('pay-btn');
    var acceptTerms = document.querySelector('input[name*="accept_terms"]');
    var acceptData = document.querySelector('input[name*="accept_data"]');
    var emailInput = document.getElementById('payment-email-input');
    
    // Campos de tarjeta
    var cardNumberInput = document.querySelector('input[name*="card_number"]');
    var expMonthSelect = document.querySelector('select[name*="exp_month"]');
    var expYearSelect = document.querySelector('select[name*="exp_year"]');
    var cvcInput = document.querySelector('input[name*="cvc"]');
    var cardHolderInput = document.querySelector('input[name*="card_holder"]');
    var installmentsSelect = document.querySelector('select[name*="installments"]');
    
    // Campo de Nequi
    var phoneInput = document.getElementById('nequi-phone-input');

    if (!paymentMethodSelector) {
      console.error('‚ùå No se encontraron los elementos del formulario');
      return;
    }

    console.log('‚úÖ Elementos encontrados');

  function showStep(stepElement) {
    if (paymentMethodSelection) paymentMethodSelection.style.display = 'none';
    if (cardTypeSelection) cardTypeSelection.style.display = 'none';
    if (paymentFormSection) paymentFormSection.style.display = 'none';
    
    if (stepElement) {
      stepElement.style.display = 'block';
    }
    validateAndEnableButton();
  }

  function validateAndEnableButton() {
    var method = paymentMethodSelector ? paymentMethodSelector.value : '';
    
    // Campos comunes a TODOS los m√©todos de pago
    var terms = acceptTerms ? acceptTerms.checked : false;
    var data = acceptData ? acceptData.checked : false;
    var email = emailInput ? emailInput.value : '';
    var hasEmail = email && email.includes('@');
    
    console.log('üîç Validando m√©todo:', method, { terms: terms, data: data, email: hasEmail });

    // Si no hay m√©todo seleccionado, deshabilitar
    if (!method) {
      console.log('‚ùå No hay m√©todo seleccionado');
      disableButton();
      return;
    }

    // Validar campos comunes (obligatorios siempre)
    if (!terms || !data || !hasEmail) {
      console.log('‚ùå Faltan campos comunes', { terms: terms, data: data, email: hasEmail });
      disableButton();
      return;
    }

    // Validaci√≥n espec√≠fica por m√©todo
    var isValid = false;

    if (method === 'cash') {
      console.log('‚úÖ Efectivo - v√°lido');
      isValid = true;
      
    } else if (method === 'nequi') {
      var phone = phoneInput ? phoneInput.value : '';
      isValid = phone && phone.length === 10 && phone.startsWith('3');
      console.log('üí∞ Nequi:', isValid ? '‚úÖ v√°lido' : '‚ùå inv√°lido', 'phone:', phone);
      
    } else if (method === 'card') {
      var cardType = cardTypeSelector ? cardTypeSelector.value : '';
      var cardNumber = cardNumberInput ? cardNumberInput.value.replace(/\s/g, '') : '';
      var expMonth = expMonthSelect ? expMonthSelect.value : '';
      var expYear = expYearSelect ? expYearSelect.value : '';
      var cvc = cvcInput ? cvcInput.value : '';
      var cardHolder = cardHolderInput ? cardHolderInput.value.trim() : '';
      
      isValid = cardType && 
                cardNumber && cardNumber.length >= 13 && cardNumber.length <= 19 &&
                expMonth && expYear && 
                cvc && cvc.length >= 3 && 
                cardHolder.length > 0;
      
      console.log('üí≥ Tarjeta:', isValid ? '‚úÖ v√°lida' : '‚ùå inv√°lida');
    }

    if (isValid) {
      enableButton();
    } else {
      disableButton();
    }
  }

  function enableButton() {
    if (payBtn) {
      payBtn.disabled = false;
      payBtn.style.opacity = '1';
      payBtn.style.cursor = 'pointer';
      console.log('‚úÖ Bot√≥n habilitado');
    }
  }

  function disableButton() {
    if (payBtn) {
      payBtn.disabled = true;
      payBtn.style.opacity = '0.5';
      payBtn.style.cursor = 'not-allowed';
      console.log('üö´ Bot√≥n deshabilitado');
    }
  }

  function handlePaymentMethodClick(e) {
    var card = e.currentTarget;
    var method = card.getAttribute('data-method');
    console.log('üí≥ M√©todo seleccionado:', method);
    
    if (paymentMethodSelector) {
      paymentMethodSelector.value = method;
    }
    
    if (method === 'card') {
      showStep(cardTypeSelection);
    } else {
      if (cardFields) cardFields.style.display = 'none';
      if (nequiFields) nequiFields.style.display = method === 'nequi' ? 'block' : 'none';
      showStep(paymentFormSection);
    }
  }

  function handleCardTypeClick(e) {
    var card = e.currentTarget;
    var cardType = card.getAttribute('data-card-type');
    console.log('üé¥ Tipo de tarjeta:', cardType);
    
    if (cardTypeSelector) {
      cardTypeSelector.value = cardType;
    }
    
    if (cardType === 'debit') {
      if (installmentsField) installmentsField.style.display = 'none';
      if (installmentsSelect) installmentsSelect.value = '1';
    } else {
      if (installmentsField) installmentsField.style.display = 'block';
    }
    
    if (cardFields) cardFields.style.display = 'block';
    if (nequiFields) nequiFields.style.display = 'none';
    showStep(paymentFormSection);
  }

  function handleBackButtonClick(e) {
    var btn = e.currentTarget;
    var targetId = btn.getAttribute('data-back-to');
    var targetElement = document.getElementById(targetId);
    showStep(targetElement);
  }

  function handleBackFromForm() {
    var method = paymentMethodSelector ? paymentMethodSelector.value : '';
    if (method === 'card') {
      showStep(cardTypeSelection);
    } else {
      showStep(paymentMethodSelection);
    }
  }

  function handleFormSubmit(e) {
    console.log('üìù Formulario enviado');
    
    var method = paymentMethodSelector ? paymentMethodSelector.value : '';
    var email = emailInput ? emailInput.value : '';
    var terms = acceptTerms ? acceptTerms.checked : false;
    var data = acceptData ? acceptData.checked : false;

    console.log('M√©todo:', method);
    console.log('Email:', email);
    console.log('Terms:', terms);
    console.log('Data:', data);

    if (!method) {
      console.log('‚ùå Falta m√©todo de pago');
      e.preventDefault();
      alert('Por favor selecciona un m√©todo de pago');
      return false;
    }

    if (!email || !email.includes('@')) {
      console.log('‚ùå Email inv√°lido');
      e.preventDefault();
      alert('Por favor ingresa un email v√°lido');
      return false;
    }

    if (!terms || !data) {
      console.log('‚ùå Faltan t√©rminos y condiciones');
      e.preventDefault();
      alert('Debes aceptar los t√©rminos y condiciones');
      return false;
    }

    if (method === 'nequi') {
      var phone = phoneInput ? phoneInput.value : '';
      console.log('Tel√©fono Nequi:', phone);
      
      if (!phone || phone.length !== 10 || !phone.startsWith('3')) {
        console.log('‚ùå Tel√©fono Nequi inv√°lido');
        e.preventDefault();
        alert('Por favor ingresa un n√∫mero de celular v√°lido (debe empezar con 3 y tener 10 d√≠gitos)');
        return false;
      }
    }

    if (method === 'card') {
      var cardType = cardTypeSelector ? cardTypeSelector.value : '';
      var cardNumber = cardNumberInput ? cardNumberInput.value.replace(/\s/g, '') : '';
      var expMonth = expMonthSelect ? expMonthSelect.value : '';
      var expYear = expYearSelect ? expYearSelect.value : '';
      var cvc = cvcInput ? cvcInput.value : '';
      var cardHolder = cardHolderInput ? cardHolderInput.value : '';

      if (!cardType || !cardNumber || !expMonth || !expYear || !cvc || !cardHolder) {
        console.log('‚ùå Faltan campos de tarjeta');
        e.preventDefault();
        alert('Por favor completa todos los campos de la tarjeta');
        return false;
      }
    }

    console.log('‚úÖ Validaci√≥n pasada, enviando formulario...');
    if (payBtn) {
      payBtn.disabled = true;
      payBtn.value = 'Procesando...';
    }
    return true;
  }

  // Inicializar eventos - M√©todos de pago
  var paymentCards = document.querySelectorAll('.payment-method-card[data-method]');
  for (var i = 0; i < paymentCards.length; i++) {
    paymentCards[i].addEventListener('click', handlePaymentMethodClick);
  }

  // Inicializar eventos - Tipos de tarjeta
  var cardTypeCards = document.querySelectorAll('.payment-method-card[data-card-type]');
  for (var j = 0; j < cardTypeCards.length; j++) {
    cardTypeCards[j].addEventListener('click', handleCardTypeClick);
  }

  // Inicializar eventos - Botones de volver
  var backButtons = document.querySelectorAll('.back-button[data-back-to]');
  for (var k = 0; k < backButtons.length; k++) {
    backButtons[k].addEventListener('click', handleBackButtonClick);
  }

  var backFromFormBtn = document.getElementById('back-from-form');
  if (backFromFormBtn) {
    backFromFormBtn.addEventListener('click', handleBackFromForm);
  }

  // Listeners para validaci√≥n en tiempo real
  var elementsToValidate = [
    acceptTerms, 
    acceptData, 
    emailInput, 
    phoneInput, 
    cardNumberInput,
    expMonthSelect, 
    expYearSelect, 
    cvcInput, 
    cardHolderInput
  ];

  for (var m = 0; m < elementsToValidate.length; m++) {
    var element = elementsToValidate[m];
    if (element) {
      element.addEventListener('change', validateAndEnableButton);
      element.addEventListener('input', validateAndEnableButton);
    }
  }

  // Validaci√≥n final en submit
  if (form) {
    form.addEventListener('submit', handleFormSubmit);
  }

  // Inicializar vista
  showStep(paymentMethodSelection);
  disableButton();
  
  console.log('‚úÖ Formulario completamente inicializado');
}

// Inicializar cuando la p√°gina cargue
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializePaymentForm);
} else {
  initializePaymentForm();
}

// Reinicializar cuando Turbo cargue una nueva p√°gina
document.addEventListener('turbo:load', initializePaymentForm);
document.addEventListener('turbo:render', initializePaymentForm);
  </script>