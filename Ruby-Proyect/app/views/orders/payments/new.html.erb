<div class="simple-payment-container">
  <div class="simple-payment-header">
    <h1><%= t("home.order-pago.pagar_orden")%> <%= @order.code %></h1>
    <p><%= t("home.order-pago.completa")%></p>
  </div>

  <div class="simple-payment-grid">
    <!-- Order Summary -->
    <div class="simple-order-summary">
      <h3><%= t("home.order-pago.resumen")%></h3>
      
      <div class="simple-order-items">
        <% @order.order_items.each do |item| %>
          <div class="simple-order-item">
            <div class="item-info">
              <span class="item-name"><%= item.product.nombre %></span>
              <span class="item-details"> 
                <%= t("home.ordenes.cantidadd")%> <%= item.quantity %> x 
                <span class="precio" >
                  <strong class= "precio-unitario" data-precio="<%= item.product.precio %>" data-locale="<%= I18n.locale %>"></strong> 
                </span>
              </span>
            </div>
            <span class="item-total">
              <strong class= "precio-unitario" data-precio="<%= item.quantity * item.product.precio %>" data-locale="<%= I18n.locale %>"></strong> 
            </span>
          </div>
        <% end %>
      </div>

      <div class="simple-order-footer">
        <% if @order.coupon.present? %>
          <div class="coupon-line">
            <span>Cupón (<%= @order.coupon.codigo %>):</span>
            <span class="discount">
              <% if @order.coupon.tipo_descuento == "porcentaje" %>
                - <%= @order.coupon.valor.to_i %>%
              <% else %>
                - <%= number_to_currency(@order.coupon.valor, unit: "COP ", separator: ",", delimiter: ".") %>
              <% end %>
            </span>
          </div>
        <% end %>
        
        <div class="total-line">
          <span><%= t("home.carrito.total_pagar")%></span>
          <span class="total-amount">
            <span class="precio">
              <strong class="precio-total"
                data-precio="<%= @order.total %>"
                data-locale="<%= I18n.locale %>"> 
                <% if I18n.locale == :en %>
                  <%= number_to_currency(@order.total/ 4000, unit: "USD", format: "%n %u", precision: 2) %>
                <% else %>
                  <%= number_to_currency(@order.total, unit: "COP", format: "%n %u", precision: 2) %>
                <% end %>
              </strong>
            </span>
          </span>
        </div>
      </div>
    </div>

    <!-- Payment Form -->
    <div class="simple-payment-form">
      <h3><%= t("home.order-pago.info_pago")%></h3>
      
      <%= form_with model: [@order, @payment], local: true, html: { id: "payment-form", class: "simple-form" } do |f| %>
        <div class="form-field">
          <%= f.label :card_number, t("home.order-pago.numero-tarjeta"), class: "field-label" %>
          <%= f.text_field :card_number, 
              maxlength: 19, 
              required: true, 
              class: "field-input", 
              placeholder: "1234 5678 9012 3456",
              inputmode: "numeric",
              pattern: "[0-9\s]*",
              autocomplete: "cc-number" %>
          <span id="error-card" class="error-msg"></span>
        </div>

        <div class="form-row">
          <div class="form-field">
            <%= f.label :exp_month, t("home.order-pago.mes-expiracion"), class: "field-label" %>
            <%= f.select :exp_month, 
                options_for_select((1..12).map { |m| [sprintf("%02d", m), m] }, nil), 
                { prompt: "Mes" }, 
                { required: true, class: "field-select" } %>
            <span id="error-month" class="error-msg"></span>
          </div>

          <div class="form-field">
            <%= f.label :exp_year, t("home.order-pago.año-expiracion"), class: "field-label" %>
            <%= f.select :exp_year, 
                options_for_select((Date.today.year..(Date.today.year+10)).map { |y| [y.to_s, y] }, nil), 
                { prompt: "Año" }, 
                { required: true, class: "field-select" } %>
            <span id="error-year" class="error-msg"></span>
          </div>
        </div>

        <div class="form-row">
          <div class="form-field">
            <%= f.label :cvc, "CVC", class: "field-label" %>
            <%= f.text_field :cvc, 
                maxlength: 4, 
                required: true, 
                class: "field-input", 
                placeholder: "123",
                inputmode: "numeric",
                pattern: "[0-9]*",
                autocomplete: "cc-csc" %>
            <span id="error-cvc" class="error-msg"></span>
          </div>

          <div class="form-field">
            <%= f.label :card_holder, t("home.order-pago.nombre-titular"), class: "field-label" %>
            <%= f.text_field :card_holder, 
                required: true, 
                class: "field-input", 
                placeholder: t("home.order-pago.nombre_completo"),
                value: @order.customer_name %>
            <span id="error-holder" class="error-msg"></span>
          </div>
        </div>

        <div class="form-field">
          <%= f.label :email, t("home.order-pago.correo-electronico"), class: "field-label" %>
          <%= f.email_field :email, 
              required: true, 
              class: "field-input", 
              placeholder: "tu@email.com",
              value: @order.customer_email %>
          <span id="error-email" class="error-msg"></span>
        </div>

        <div class="checkbox-section">
          <div class="checkbox-item">
            <%= f.check_box :accept_terms, required: true, class: "checkbox" %>
            <%= f.label :accept_terms, class: "checkbox-label" do %>
              Acepto los 
              <a href="https://wompi.com/assets/downloadble/reglamento-Usuarios-Colombia.pdf?_gl=1*126i4oi*_gcl_aw*R0NMLjE3NTYyMjY0MjQuQ2p3S0NBand0clhGQmhCaUVpd0FFK2VuMXpvMWtBb2dwUkpBWklvc3JjNkJuZ3NIRktrMVRfT3hzODRBWnFTQXdhNGd2Z3JLaVhBWGhSb0NJVnNRQXZEX0J3RQ..*_gcl_au*MjA5MDc4MDUwMy4xNzU1NzE1ODAz*_ga*MTMzNjc3NjQyNC4xNzU1NzE1ODA1*_ga_BQ9HE5B63X*czE3NTYyMjY0MzUkbzE0JGcxJHQxNzU2MjI2ODQ2JGo2MCRsMCRoMA.." target="_blank">términos y condiciones</a>
              de Wompi
            <% end %>
          </div>

          <div class="checkbox-item">
            <%= f.check_box :accept_data, required: true, class: "checkbox" %>
            <%= f.label :accept_data, class: "checkbox-label" do %>
              Acepto la
              <a target="_blank" href="https://wompi.com/assets/downloadble/autorizacion-tratamiento-datos-personales.pdf?_gl=1*jcrp79*_gcl_aw*R0NMLjE3NTYyMjY0MjQuQ2p3S0NBand0clhGQmhCaUVpd0FFK2VuMXpvMWtBb2dwUkpBWklvc3JjNkJuZ3NIRktrMVRfT3hzODRBWnFTQXdhNGd2Z3JLaVhBWGhSb0NJVnNRQXZEX0J3RQ..*_gcl_au*MjA5MDc4MDUwMy4xNzU1NzE1ODAz*_ga*MTMzNjc3NjQyNC4xNzU1NzE1ODA1*_ga_BQ9HE5B63X*czE3NTYyMjY0MzUkbzE0JGcxJHQxNzU2MjI2NTU3JGo0JGwwJGgw">autorización para la administración de datos personales</a>
              y conozco la 
              <a target="_blank" href="https://wompi.com/es/co/politica-de-privacidad?_gl=1*13f7i2g*_gcl_aw*R0NMLjE3NTYyMjY0MjQuQ2p3S0NBand0clhGQmhCaUVpd0FFK2VuMXpvMWtBb2dwUkpBWklvc3JjNkJuZ3NIRktrMVRfT3hzODRBWnFTQXdhNGd2Z3JLaVhBWGhSb0NJVnNRQXZEX0J3RQ..*_gcl_au*MjA5MDc4MDUwMy4xNzU1NzE1ODAz*_ga*MTMzNjc3NjQyNC4xNzU1NzE1ODA1*_ga_BQ9HE5B63X*czE3NTYyMjY0MzUkbzE0JGcxJHQxNzU2MjI2NTU3JGo0JGwwJGgw" target="_blank">política para el tratamiento de datos personales.</a>
            <% end %>
          </div>
        </div>

        <%= f.hidden_field :installments, value: 1 %>

        <div class="submit-section">
          <%= f.submit t("home.order-pago.pagar"), id: "pay-btn", class: "pay-button", disabled: true %>
          <p class="security-note">🔒 <%= t("home.order-pago.pago_seguro")%></p>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
document.addEventListener('turbo:load', function() {
  // Función para permitir solo números
  function onlyNumbers(event) {
    const char = String.fromCharCode(event.which);
    // Permitir: backspace, delete, tab, escape, enter
    if ([8, 9, 27, 13, 46].indexOf(event.keyCode) !== -1 ||
        // Permitir Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
        (event.keyCode === 65 && event.ctrlKey === true) ||
        (event.keyCode === 67 && event.ctrlKey === true) ||
        (event.keyCode === 86 && event.ctrlKey === true) ||
        (event.keyCode === 88 && event.ctrlKey === true)) {
      return;
    }
    // Asegurar que es un número (0-9)
    if (!/[0-9]/.test(char)) {
      event.preventDefault();
    }
  }

  // Aplicar validación solo a número de tarjeta y CVC
  const cardNumberInput = document.querySelector('input[name*="card_number"]');
  const cvcInput = document.querySelector('input[name*="cvc"]');

  if (cardNumberInput) {
    cardNumberInput.addEventListener('keydown', onlyNumbers);
    // Prevenir pegar texto no numérico
    cardNumberInput.addEventListener('paste', function(event) {
      setTimeout(() => {
        this.value = this.value.replace(/[^0-9]/g, '');
      }, 10);
    });
  }

  if (cvcInput) {
    cvcInput.addEventListener('keydown', onlyNumbers);
    // Prevenir pegar texto no numérico
    cvcInput.addEventListener('paste', function(event) {
      setTimeout(() => {
        this.value = this.value.replace(/[^0-9]/g, '');
      }, 10);
    });
  }

  // Ajustar altura del resumen de orden al formulario de pago
  function matchHeights() {
    const paymentForm = document.querySelector('.simple-payment-form');
    const orderSummary = document.querySelector('.simple-order-summary');
    
    if (paymentForm && orderSummary && window.innerWidth > 768) {
      // Solo en desktop
      const paymentHeight = paymentForm.offsetHeight;
      orderSummary.style.setProperty('--target-height', paymentHeight + 'px');
      orderSummary.classList.add('height-matched');
    } else if (orderSummary) {
      // En móvil, quitar restricciones de altura
      orderSummary.classList.remove('height-matched');
      orderSummary.style.removeProperty('--target-height');
    }
  }

  // Ejecutar al cargar y al redimensionar
  matchHeights();
  window.addEventListener('resize', matchHeights);
});
</script>