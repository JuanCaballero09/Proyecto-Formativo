#!/usr/bin/env bash
# encoding: UTF-8
# Script para configurar PostgreSQL y preparar la base de datos de producciÃ³n
# Ejecutar UNA VEZ antes de iniciar el servidor en producciÃ³n

set -e

echo ""
echo "======================================================================"
echo "           BITEVIA - ConfiguraciÃ³n de ProducciÃ³n"
echo "======================================================================"
echo ""

# ============================================================
# CONFIGURACIÃ“N - EDITA ESTOS VALORES
# ============================================================

# Usuario de PostgreSQL (el que se crearÃ¡)
PG_USER="bitevia"

# ContraseÃ±a para el usuario de PostgreSQL
# âš ï¸ CAMBIA ESTO POR UNA CONTRASEÃ‘A SEGURA
PG_PASSWORD="09212006"

# Nombre de la base de datos de desarrollo (para importar datos)
DB_DEV="myapp_developmen"

# Nombres de bases de datos de producciÃ³n
DB_PROD_PRIMARY="bitevia_backend_production"
DB_PROD_CACHE="bitevia_backend_production_cache"
DB_PROD_QUEUE="bitevia_backend_production_queue"
DB_PROD_CABLE="bitevia_backend_production_cable"

# ============================================================
# NO EDITES DEBAJO DE ESTA LÃNEA
# ============================================================

echo "ðŸ“‹ ConfiguraciÃ³n:"
echo "   Usuario PostgreSQL: $PG_USER"
echo "   Base de datos dev:  $DB_DEV"
echo "   Base de datos prod: $DB_PROD_PRIMARY"
echo ""

# Verificar si el usuario de PostgreSQL ya existe
echo "ðŸ” Verificando usuario de PostgreSQL..."
if sudo -u postgres psql -tAc "SELECT 1 FROM pg_roles WHERE rolname='$PG_USER'" | grep -q 1; then
    echo "   âœ… Usuario '$PG_USER' ya existe"
else
    echo "   ðŸ”§ Creando usuario '$PG_USER'..."
    sudo -u postgres createuser -s "$PG_USER"
    echo "   âœ… Usuario creado"
fi

# Establecer contraseÃ±a
echo "ðŸ” Configurando contraseÃ±a..."
sudo -u postgres psql -c "ALTER USER $PG_USER WITH PASSWORD '$PG_PASSWORD';"
echo "   âœ… ContraseÃ±a configurada"

# Exportar variable de entorno
echo "ðŸŒ Exportando variable de entorno..."
export RUBY_DATABASE_PASSWORD="$PG_PASSWORD"
echo "   âœ… Variable exportada: RUBY_DATABASE_PASSWORD"

# Crear bases de datos
echo "ðŸ—„ï¸  Creando bases de datos de producciÃ³n..."
for db in "$DB_PROD_PRIMARY" "$DB_PROD_CACHE" "$DB_PROD_QUEUE" "$DB_PROD_CABLE"; do
    PGPASSWORD="$PG_PASSWORD" psql -U $PG_USER -h localhost -c "CREATE DATABASE $db;" 2>/dev/null || echo "   â„¹ï¸  $db ya existe"
done
echo "   âœ… Todas las bases de datos listas"

# Ejecutar migraciones
echo "ðŸ”„ Ejecutando migraciones..."
RAILS_ENV=production PGPASSWORD="$PG_PASSWORD" bin/rails db:migrate
echo "   âœ… Migraciones completadas"

# Preguntar si desea importar datos de desarrollo
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ“¦ IMPORTACIÃ“N DE DATOS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
read -p "Â¿Deseas importar los datos de desarrollo a producciÃ³n? (s/n): " -n 1 -r
echo ""

if [[ $REPLY =~ ^[SsYy]$ ]]; then
    echo ""
    echo "ðŸ”„ Exportando datos de desarrollo..."
    
    # Crear directorio temporal
    mkdir -p tmp/db_backup
    
    # Exportar datos de desarrollo
    echo "   ðŸ“¤ Exportando desde $DB_DEV..."
    PGPASSWORD="$PG_PASSWORD" pg_dump -U $PG_USER -h localhost -Fc $DB_DEV > tmp/db_backup/development_backup.dump
    echo "   âœ… ExportaciÃ³n completada"
    
    echo "   ðŸ“¥ Importando a producciÃ³n..."
    
    # Importar usando pg_restore
    echo "   ðŸ”„ Restaurando datos en $DB_PROD_PRIMARY..."
    PGPASSWORD="$PG_PASSWORD" pg_restore -h localhost -U $PG_USER -d $DB_PROD_PRIMARY tmp/db_backup/development_backup.dump --clean --if-exists --no-owner --no-acl 2>/dev/null || true
    
    echo "   âœ… ImportaciÃ³n completada"
    echo "   ðŸ§¹ Limpiando archivos temporales..."
    rm -rf tmp/db_backup
    echo "   âœ… Datos importados exitosamente"
    
    # Precargar imÃ¡genes optimizadas
    echo ""
    read -p "Â¿Deseas precargar las imÃ¡genes optimizadas (WebP)? (s/n): " -n 1 -r
    echo ""
    if [[ $REPLY =~ ^[SsYy]$ ]]; then
        echo "   ðŸ–¼ï¸  Precargando imÃ¡genes optimizadas..."
        RAILS_ENV=production bin/rails images:preload
        echo "   âœ… ImÃ¡genes precargadas"
    else
        echo "   â­ï¸  Saltando precarga de imÃ¡genes"
        echo "   ðŸ’¡ Puedes hacerlo despuÃ©s con: RAILS_ENV=production rails images:preload"
    fi
else
    echo ""
    echo "   â­ï¸  Saltando importaciÃ³n de datos"
    echo ""
    echo "   ðŸ’¡ Si quieres importar datos manualmente mÃ¡s tarde, ejecuta:"
    echo "      export RUBY_DATABASE_PASSWORD='$PG_PASSWORD'"
    echo "      pg_dump -U $PG_USER -h localhost -Fc $DB_DEV > backup.dump"
    echo "      pg_restore -U $PG_USER -h localhost -d $DB_PROD_PRIMARY backup.dump --no-owner --no-acl"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… CONFIGURACIÃ“N COMPLETADA"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ðŸ“ SIGUIENTE PASO:"
echo ""
echo "   Para iniciar el servidor en producciÃ³n, ejecuta:"
echo ""
echo "   export RUBY_DATABASE_PASSWORD='$PG_PASSWORD'"
echo "   RAILS_ENV=production ./bin/server"
echo ""
echo "   O agrega la variable al archivo ~/.bashrc para que persista:"
echo ""
echo "   echo \"export RUBY_DATABASE_PASSWORD='$PG_PASSWORD'\" >> ~/.bashrc"
echo "   source ~/.bashrc"
echo ""
echo "======================================================================"
echo ""
